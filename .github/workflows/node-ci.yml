name: Node.js CI

on:
  push:
    branches: [main]
  # pull_request:
  #   branches: [main]

permissions:
  contents: write

env:
  VERSION: 1.1.3
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm install

      # Step 4: Run linting
      - name: Run linting
        run: npx eslint server.js

      # Step 5: Run tests
      - name: Run tests
        run: npm test

      # Step 6: Build artifact
      - name: Build artifact
        run: |
          tar -czf nodeproject-${VERSION}.tar.gz ./*


#      # Step 7: Commit and push artifact to the same GitHub repo
#      - name: Commit and push artifact
#        run: |
#          git config --local user.email "rajeshecb70@gmail.com"
#          git config --local user.name "rajeshecb70"
#          git add nodeproject-${VERSION}.tar.gz
#          git commit -m "Upload artifact"
#          git push

      # Step 7: Debug the file existence
      - name: Debug file existence
        run: |
          echo "Listing files in the workspace"
          ls -alh ${GITHUB_WORKSPACE}
          pwd
          echo "Checking if the tar file exists"
          ls -alh nodeproject-${VERSION}.tar.gz


      # Step 8: Upload artifact to the Azure server via SSH#
      - name: Upload artifact to Azure server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_SERVER_IP }}
          username: ${{ secrets.AZURE_SERVER_USERNAME }}
          password: ${{ secrets.AZURE_SERVER_PASSWORD }}
          source: "nodeproject-${VERSION}.tar.gz"
          target: "/home/azureuser/"



#      - name: executing remote ssh commands using password
#        uses: appleboy/ssh-action@v1.2.0
#        with:
#          host: ${{ secrets.HOST }}
#          username: ${{ secrets.USERNAME }}
#          key: ${{ secrets.KEY }}
#          port: ${{ secrets.PORT }}
#          script: |      
#            cd /home/ubuntu
#            tar -xvf nodeproject.tar.gz
#            npm i
#            if  pm2 list | grep -q "node-project"; then
#                echo "Restarting the running application 'nodeproject'..."
#                pm2 restart nodeproject
#            else
#                echo "Starting the application 'nodeproject..."
#                pm2 start server.js --name nodeproject -i max
#            fi
#            pm2 save
            
